	SUBROUTINE prep(ENPDB,NRES,CHNM,K1,K2)
	CHARACTER*150 ENPDB
	CHARACTER*62 HEADP
	CHARACTER*4 ENPDB1,ftt
	CHARACTER*1  NAMCH(29000), NACH, NAMCHC,NNMCH,AA,NNMCHCC
	CHARACTER*6 DEF
	CHARACTER*3 NAMR(29000),NAMRC,LISTCOF(200),NNMAR,NMR
     2	,NAM3(20),NMF3,NAM3CC
	CHARACTER*1 ALET(10),CHNM
     2	,CMET(29000),CA1(29000),CA2(29000),CA3(29000),A1F
     3	,READI,LISTCH(200),ALET1(13)
	CHARACTER*1 NCHINSQ(4000),NMF1,NCHCOF(200)
	CHARACTER*1 LNMC1(200,30), LNMC2(200,30), LNMC3(200,30)
	CHARACTER*1 LNMO1(200,30), LNMO2(200,30), LNMO3(200,30)
	CHARACTER*1 LNMN1(200,30), LNMN2(200,30), LNMN3(200,30)
	INTEGER*4 SVT(36),
     2	NFAR(20)
     3	,LBCH(200),NCOFR(200),NCOFACT,NAEC(29000)
     4	,HBCH(200),NCOFIJR(200),HBCOF(200)
	INTEGER*2 COD(29000),SVA(29000),SVAR(167)
	COMMON /CFTT/ftt
	COMMON /CALET/ ALET,ALET1
	COMMON /CNAM/ NAM3
	COMMON /CSVAR/ SVAR
	COMMON /CANCOF/	NACCOF(200),NAOCOF(200),NANCOF(200)
	COMMON /CNFAR/	NFAR
	COMMON /CLNB/	LNBC(200,30),LNBO(200,30),LNBN(200,30)
	COMMON /CLNMC/ LNMC1,LNMC2,LNMC3
	COMMON /CLNMO/ LNMO1,LNMO2,LNMO3
	COMMON /CLNMN/ LNMN1,LNMN2,LNMN3
	COMMON /CNACOF/	LBCOF(200),HBCOF
	COMMON /CXYZ/	X(29000),Y(29000),Z(29000)
	COMMON /CENPDB/	ENPDB1
	COMMON /CNCOFACT/ NNNCOF
	COMMON /CNMF1/	NMF1
	COMMON /CUNUS/ IAPROT,IAUNUS
	COMMON /CNRF/	NRF
	COMMON /CNMF3/	NMF3
	COMMON /CIJR/	IJR
	COMMON /NMC/	NACH, NAMR, NAMCH
	COMMON /NOC/	NOR1, NOR(29000)
	COMMON /SVC/	SVA
c	COMMON /CNAB/	NAB(4000), NAE(4000)
	COMMON /CSVT/	SVT
	COMMON /CRA/	RA(13), SN, ZN, SZP, SAP
	COMMON /NABEC/ 	NAB(4000),NAE(4000),NRINSQ(4000)
	COMMON /CXCR/	XCR(4000), YCR(4000), ZCR(4000), RDR(4000)
	COMMON /CCCOD/	COD
	COMMON /CNTYP/	NTYP
	COMMON /CNN1/	NA
	COMMON /COMCC/	CMET, CA1, CA2, CA3
     	COMMON /UACC/ 	XUACC(1000), YUACC(1000), ZUACC(1000)
	ijrmm=0
	NTYP=8
	IJRMM=0
	NNNCOF=NCOFACT
	OPEN (1,FILE=ENPDB, STATUS='OLD')
	READ (1,4883) HEADP,ENPDB1
	ftt=ENPDB1
 4883	FORMAT(A62,A4)
	J=0
	JCONECT=0
    1	J=J+1
	READ (1,1001) DEF
 1001	FORMAT (A6,A72)
	IF (DEF.EQ.'ATOM'.OR.DEF.EQ.'HETATM') GOTO 2
	GOTO 1
    2	JF=J
    5	CLOSE (1)
	OPEN (2,FILE=ENPDB, STATUS='OLD')
	DO 100 I=1,JF
  100	READ (2,1001) DEF
	IA=0
	IAPROT=0
	IAUNUS=0
	N1MEM=0
	NNMCHCC=' '
	N2MEM=0
	NUMBCH=0
	NUMBCOF=0
	READI=' '
	NAMCHC=' '
	NAMRC='   '	
   12	IA=IA+1
   13	READ (2,1018) DEF,NAEC(IA),CMET(IA),CA1(IA),CA2(IA),CA3(IA)
     2	,AA,NAMR(IA),NAMCH(IA),NOR(IA),X(IA),Y(IA),Z(IA)
 1018	FORMAT(A6,I5,1X,5A1,A3,1X,A1,I4,4X,3F8.3)
	IF (IA.EQ.1) THEN
	NNMAR=NAMR(1)
	IJR=1
	NNMCH=NAMCH(1)
	NNOR=NOR(1)
	NAB(1)=1
	NRINSQ(1)=NNOR
	NCHINSQ(1)=NNMCH
	IF (NNOR.EQ.NRES.AND.NNMCH.EQ.CHNM) IJRMM=1
	END IF
	IF (CA1(IA).EQ.'H') GOTO 13
	IF (AA.NE.'A'.AND.AA.NE.' ') THEN
	IF (NOR(IA).NE.N2MEM) THEN
	N2MEM=NOR(IA)
	END IF
	GOTO 13
	END IF
	IF (AA.EQ.'A'.AND.NOR(IA).NE.N1MEM) N1MEM=NOR(IA)
 	IF (DEF.NE.'ATOM') GOTO 14
	NAM3CC=NAMR(IA)
	DO 300 II1=1,20
	IF (NAM3CC.EQ.NAM3(II1)) GOTO 301
  300	CONTINUE
	IAUNUS=IAUNUS+1
	GOTO 13
  301	IAPROT=IAPROT+1
	IF (NNMAR.EQ.NAMR(IA).AND.NNMCH.EQ.NAMCH(IA)
     2	.AND.NNOR.EQ.NOR(IA)) GOTO 16
	NNMAR=NAMR(IA)
	NNMCH=NAMCH(IA)
	NNOR=NOR(IA)
	IF (IJR.NE.0) NAE(IJR)=IA-1
	IJR=IJR+1
	IF (NNOR.EQ.NRES.AND.NNMCH.EQ.CHNM) IJRMM=IJR
	NAB(IJR)=IA
	NRINSQ(IJR)=NNOR
	NCHINSQ(IJR)=NNMCH
   16	CONTINUE
	IF (READI.EQ.'P'.AND.NAMCH(IA).EQ.NAMCHC) GOTO 12
	NUMBCH=NUMBCH+1
	READI='P'
	LBCH(NUMBCH)=IA
	LISTCH(NUMBCH)=NAMCH(IA)
	NAMCHC=NAMCH(IA)
	GOTO 12 
   14	CONTINUE
	IF (DEF.NE.'HETATM') GOTO 15
	IF (NAMR(IA).EQ.'HOH') GOTO 13
	IF (READI.EQ.'C'.AND.NAMR(IA).EQ.NAMRC.AND
     K.NNORCC.EQ.NOR(IA).AND.NNMCHCC.EQ.NAMCH(IA)) GOTO 12
	NNMAR=NAMR(IA)
	NNMCH=NAMCH(IA)
	NNOR=NOR(IA)
	NAE(IJR)=IA-1
	IJR=IJR+1
	NAB(IJR)=IA
	NRINSQ(IJR)=NNOR
	NCHINSQ(IJR)=NNMCH
	NUMBCOF=NUMBCOF+1
	NCOFIJR(NUMBCOF)=IJR
	READI='C'
	LBCOF(NUMBCOF)=IA
	LISTCOF(NUMBCOF)=NAMR(IA)
	NCOFR(NUMBCOF)=NOR(IA)
	NCHCOF(NUMBCOF)=NAMCH(IA)
	NAMRC=NAMR(IA)
	NNORCC=NOR(IA)
	NNMCHCC=NAMCH(IA)
	GOTO 12
   15	CONTINUE
	IF (DEF.EQ.'TER') GOTO 13
  655	NA=IA-1
	close (2)
	DO  106 I=1,NUMBCH
	HBCH(I)=NA
	IF (I.NE.NUMBCH) HBCH(I)=LBCH(I+1)-1
	IF (NUMBCOF.EQ.0) GOTO 106
	DO 107 J=1,NUMBCOF
	CONTINUE
	IF (LBCOF(J).LT.LBCH(I)) GOTO 107
	IF (LBCOF(J).LE.HBCH(I)) HBCH(I)=LBCOF(J)-1
	GOTO 106
  107	CONTINUE
  106	CONTINUE
	DO  108 I=1,NUMBCOF
	HBCOF(I)=NA
	IF (I.NE.NUMBCOF) HBCOF(I)=LBCOF(I+1)-1
	IF (NUMBCH.EQ.0) GOTO 108
	DO 109 J=1,NUMBCH
	CONTINUE
	IF (LBCH(J).LT.LBCOF(I)) GOTO 109
	IF (LBCH(J).LE.HBCOF(I)) HBCOF(I)=LBCH(J)-1
	GOTO 108
  109	CONTINUE
  108	CONTINUE
	NAE(IJR)=NA
	DO 112 I=1,IJR
	XC=0.
	YC=0.
	ZC=0.
	XMI=10000.0
	XMA=-10000.
	YMI=XMI
	YMA=XMA
	ZMI=XMI
	ZMA=XMA
	J1=NAB(I)
	J2=NAE(I)
	DO 113 J=J1,J2
	V=X(J)
	XC=XC+V
	IF (V.GT.XMA) XMA=V
	IF (V.LT.XMI) XMI=V
	V=Y(J)
	YC=YC+V
	IF (V.GT.YMA) YMA=V
	IF (V.LT.YMI) YMI=V
	V=Z(J)
	ZC=ZC+V
	IF (V.GT.ZMA) ZMA=V
	IF (V.LT.ZMI) ZMI=V
  113	CONTINUE
	J2=J2-J1+1
	XCR(I)=XC/J2
	YCR(I)=YC/J2
	ZCR(I)=ZC/J2
	XC=XMA-XMI
	YC=YMA-YMI
	ZC=ZMA-ZMI
	V=MAX(XC,YC,ZC)
	RDR(I)=V
  112	CONTINUE
	DO 114 I=1,NA
	A1F=CA1(I)
	DO 115 J=1,13
	I1=J
	IF (A1F.EQ.ALET1(J)) GOTO 17
  115	CONTINUE
   17	COD(I)=I1
  114	CONTINUE
	DO 116 I=1,NUMBCH
	IN=100000
	IAF=LBCH(I)
	IAL=HBCH(I)
	DO 117 IA=IAF,IAL
	IF (IN.EQ.NOR(IA)) GOTO 18
	NMR=NAMR(IA)
	IN=NOR(IA)
	I1=0
	DO 118 J1= 1,20
	IF (NMR.NE.NAM3(J1)) GOTO 118
	IIR=J1
	GOTO 18
  118	CONTINUE
   18	JJ=NFAR(IIR)
	SVA(IA) = SVAR(JJ+I1)
	I1=I1+1
  117	CONTINUE
	IF (CA2(IAL).EQ.'X') SVA(IAL)= 2
  116	CONTINUE
    4	k1=nab(IJRMM)
	k2=nae(IJRMM)
	IF (IJRMM.EQ.0) K2=-2
	CALL AACOF(NUMBCOF)
	RETURN
	END
	SUBROUTINE AACOF(NUMBCOF)
	CHARACTER*1 CMET(29000),CA1(29000),CA2(29000),CA3(29000)
	CHARACTER*1 LNMC1(200,30), LNMC2(200,30), LNMC3(200,30)
	CHARACTER*1 LNMO1(200,30), LNMO2(200,30), LNMO3(200,30)
	CHARACTER*1 LNMN1(200,30), LNMN2(200,30), LNMN3(200,30)
	DIMENSION NCONTA(500),NAR(20),NARM(20,6),RM(500,6)
     2	,XX(4),YY(4),ZZ(4),NARM1(10)
	INTEGER CM(500,6),HBCOF
	INTEGER*2 SVA(29000), COD(29000)
	COMMON /CANCOF/	NACCOF(200),NAOCOF(200),NANCOF(200)
	COMMON /CLNB/	LNBC(200,30),LNBO(200,30),LNBN(200,30)
	COMMON /CLNMC/ LNMC1,LNMC2,LNMC3
	COMMON /CLNMO/ LNMO1,LNMO2,LNMO3
	COMMON /CLNMN/ LNMN1,LNMN2,LNMN3
	COMMON /CNACOF/LBCOF(200),HBCOF(200)
	COMMON /CXYZ/X(29000),Y(29000),Z(29000)
	COMMON /CCCOD/	COD
	COMMON /SVC/SVA
      COMMON /COMCC/	CMET, CA1, CA2, CA3
	DO 100 IC=1,NUMBCOF
	NAB=LBCOF(IC)
	NAE=HBCOF(IC)
	IAR=0
	IACCOF=0
	IAOCOF=0
	IANCOF=0
	DO 101 IA=NAB,NAE
	IAR=IAR+1
	ICONT=0
	X1=X(IA)
	Y1=Y(IA)
	Z1=Z(IA)
	JAR=0
	DO 102 JA=NAB,NAE
	JAR=JAR+1
	IF (IA.EQ.JA) GOTO 102
	DX=X1-X(JA)
	DY=Y1-Y(JA)
	DZ=Z1-Z(JA)
	D2=DX*DX+DY*DY+DZ*DZ
	IF(D2.GT.4.0) GOTO 102
	ICONT=ICONT+1
	CM(IAR,ICONT)=JAR
	RM(IAR,ICONT)=D2
  102	CONTINUE
	NCONTA(IAR)=ICONT
  101	CONTINUE
	NAC=IAR
	NR=0
	DO 123 IA=NAB,NAE
	SVA(IA)=6
  123	CONTINUE
	IAR=0
	DO 124 IA=NAB,NAE
	IAR=IAR+1
	IF (CA1(IA).EQ.'N') THEN
	IF (CMET(IA).EQ.'Z') GOTO 124
	SVA(IA)=1
	IANCOF=IANCOF+1
	LNBN(IC,IANCOF)=IAR
	LNMN1(IC,IANCOF)=CA1(IA)
	LNMN2(IC,IANCOF)=CA2(IA)
	LNMN3(IC,IANCOF)=CA3(IA)
	GOTO 124
	END IF
	ICONT = NCONTA(IAR)
	IF (CA1(IA).EQ.'O') THEN
	SVA (IA)=2
	IF (ICONT.GE.2) GOTO 124
	II=CM(IAR,1)
	JJ=NAB+II-1
	IF (CA1(JJ).EQ.'C') THEN
	IAOCOF=IAOCOF+1
	LNBO(IC,IAOCOF)=IAR
	LNMO1(IC,IAOCOF)=CA1(IA)
	LNMO2(IC,IAOCOF)=CA2(IA)
	LNMO3(IC,IAOCOF)=CA3(IA)
	IF (RM(IAR,1).LT.1.66) GOTO 124
	END IF
	SVA(IA)=1
	GOTO 124
	END IF
	IF (CA1(IA).EQ.'S'.OR.CA1(IA).EQ.'P') GOTO 124
	IF (COD(IA).EQ.13) GOTO 124
	IF (CMET(IA).EQ.'B'.AND.CA1(IA).EQ.'R') THEN
	SVA(IA)=4
	GOTO 124
	END IF
	IF (CMET(IA).EQ.'C'.AND.CA1(IA).EQ.'L') THEN
	SVA(IA)=4
	GOTO 124
	END IF
	IF (CMET(IA).EQ.'I'.OR.CA1(IA).EQ.'I') SVA(IA)=4
  124	CONTINUE
	IAR=0
	DO 125 IA=NAB,NAE
	IAR=IAR+1
	IF (CA1(IA).NE.'C') GOTO 125
	ICONT = NCONTA(IAR)
	IOF=0
	IOA=0
	DO 126 J=1,ICONT
	II=CM(IAR,J)
	JJ=NAB+II-1
	IF (CA1(JJ).EQ.'N') GOTO 125
	IF (CA1(JJ).EQ.'O') THEN
	IOF=IOF+1
	IF (SVA(JJ).EQ.2) IOA=IOA+1
	END IF
  126 CONTINUE
	IF (IOF.GT.1) GOTO 125
	IF (IOA.NE.0) THEN
	SVA(IA)=8
	GOTO 125
	END IF
	IF (IOF.NE.0) GOTO 125
	SVA(IA)=4
  125	CONTINUE
	DO 103 IA1=1,NAC
	NC1=NCONTA(IA1)
	IF (NC1.EQ.1) GOTO 103
	DO 104 IC1=1,NC1
	IA2=CM(IA1,IC1)
	IF (IA2.LE.IA1) GOTO 104
	NC2=NCONTA(IA2)
	IF (NC2.EQ.1) GOTO 104
	DO 105 IC2=1,NC2
	IA3=CM(IA2,IC2)
	IF (IA3.LE.IA1) GOTO 105
	NC3=NCONTA(IA3)
	IF (NC3.EQ.1) GOTO 105
	DO 106 IC3=1,NC3
	IA4=CM(IA3,IC3)
	IF (IA4.LT.IA1.OR.IA4.EQ.IA2) GOTO 106
	IF (IA4.EQ.IA1) THEN
	NR=NR+1
	NAR(NR)=3
	NARM(NR,1)=IA1
	NARM(NR,2)=IA2
	NARM(NR,3)=IA3
	IF (NR.EQ.1) GOTO 106
	NRK=NR-1
	DO 111 I=1,NRK
	IQ=0
	DO 119 J=1,2
	IF (NARM(NR,J+1).NE.NARM(I,4-J)) THEN
	IQ=1
	GOTO 1
	ENDIF
  119	CONTINUE
    1	IF (IQ.EQ.0) THEN
	NR=NR-1
	GOTO 106
	END IF
  111	CONTINUE
	GOTO 106
	END IF
	NC4=NCONTA(IA4)
	IF (NC4.EQ.1) GOTO 106
	DO 107 IC4=1,NC4
	IA5=CM(IA4,IC4)
	IF (IA5.LT.IA1.OR.IA5.EQ.IA3) GOTO 107
	IF (IA5.EQ.IA1) THEN
	NR=NR+1
	NAR(NR)=4
	NARM(NR,1)=IA1
	NARM(NR,2)=IA2
	NARM(NR,3)=IA3
	NARM(NR,4)=IA4
	IF (NR.EQ.1) GOTO 107
	NRK=NR-1
	DO 112 I=1,NRK
	IQ=0
	DO 116 J=1,3
	IF (NARM(NR,J+1).NE.NARM(I,5-J)) THEN
	IQ=1
	GOTO 2
	END IF
  116	CONTINUE
    2	IF (IQ.EQ.0) THEN
	NR=NR-1
	GOTO 107
	END IF
  112	CONTINUE
	GOTO 107
	END IF	
	NC5=NCONTA(IA5)
	IF (NC5.EQ.1) GOTO 107
	DO 108 IC5=1,NC5
	IA6=CM(IA5,IC5)
	IF (IA6.LT.IA1.OR.IA6.EQ.IA4) GOTO 108
	IF (IA6.EQ.IA1) THEN
	NR=NR+1
	NAR(NR)=5
	NARM(NR,1)=IA1
	NARM(NR,2)=IA2
	NARM(NR,3)=IA3
	NARM(NR,4)=IA4
	NARM(NR,5)=IA5
	IF (NR.EQ.1) GOTO 108
	NRK=NR-1
	DO 113 I=1,NRK
	IQ=0
	DO 117 J=1,4
	IF (NARM(NR,J+1).NE.NARM(I,6-J)) THEN
	IQ=1
	GOTO 3
	END IF
  117	CONTINUE
    3	IF (IQ.EQ.0) THEN
	NR=NR-1
	GOTO 108
	END IF
  113	CONTINUE
	GOTO 108
	END IF
	NC6=NCONTA(IA6)
	IF (NC6.EQ.1) GOTO 108
	DO 109 IC6=1,NC6
	IA7=CM(IA6,IC6)
	IF (IA7.LT.IA1.OR.IA7.EQ.IA5) GOTO 109
	IF (IA7.EQ.IA1) THEN
	NR=NR+1
	NAR(NR)=6
	NARM(NR,1)=IA1
	NARM(NR,2)=IA2
	NARM(NR,3)=IA3
	NARM(NR,4)=IA4
	NARM(NR,5)=IA5
	NARM(NR,6)=IA6
	IF (NR.EQ.1) GOTO 109
	NRK=NR-1
	DO 114 I=1,NRK
	IQ=0
	DO 118 J=1,5
	IF (NARM(NR,J+1).NE.NARM(I,7-J)) THEN
	IQ=1
	GOTO 4
	END IF
  118	CONTINUE
    4	IF (IQ.EQ.0) THEN
	NR=NR-1
	GOTO 109
	END IF
  114	CONTINUE
	END IF
  109	CONTINUE
  108	CONTINUE
  107	CONTINUE
  106	CONTINUE
  105	CONTINUE
  104	CONTINUE
  103	CONTINUE
	IF (NR.NE.0) THEN
	DO 120 IR=1,NR
	NA=NAR(IR)
	DO 130 I=1,NA
	III=NARM(IR,I)
	NX=NAB+III-1
	IF (CA1(NX).NE.'C') GOTO 130
	IACCOF=IACCOF+1
	LNBC(IC,IACCOF)=III
	LNMC1(IC,IACCOF)=CA1(NX)
	LNMC2(IC,IACCOF)=CA2(NX)
	LNMC3(IC,IACCOF)=CA3(NX)
  130	CONTINUE
	IF (NA.EQ.3) GOTO 5
	DO 127 I=1,NA
	NARM1(I)=NARM(IR,I)
  127	CONTINUE
	DO 128 I=1,3
	NARM1 (NA+I)= NARM(IR,I)
  128	CONTINUE
	COSMIN=0.906
	IF (NA.EQ.6) COSMIN=0.707
	DO 121 I=1,NA
	DO 122 J=1,4
	NX=NAB+NARM1(J+I-1)-1
	XX(J)=X(NX)
	YY(J)=Y(NX)
	ZZ(J)=Z(NX)
  122	CONTINUE
	CALL DANGL(ANGL,XX,YY,ZZ)
	IF (ANGL.LT.COSMIN) GOTO 120
  121	CONTINUE
    5	CONTINUE
	DO 129 I=1,NA
	NX=NAB+NARM(IR,I)-1
	IF (CA1(NX).NE.'C') GOTO 129
	SVA(NX)=5
  129	CONTINUE
  120	CONTINUE
	END IF
	NANCOF(IC)=IANCOF
	NAOCOF(IC)=IAOCOF
	NACCOF(IC)=IACCOF
  100	CONTINUE
	RETURN
	END
	SUBROUTINE DANGL(ANGL,X,Y,Z)
	DIMENSION X(4),Y(4),Z(4)
	A1=Y(1)*Z(2)+Z(1)*Y(3)+Y(2)*Z(3)
     2-Z(2)*Y(3)-Z(1)*Y(2)-Y(1)*Z(3)
	B1=Z(1)*X(2)+X(1)*Z(3)+Z(2)*X(3)
     2-X(2)*Z(3)-X(1)*Z(2)-Z(1)*X(3)
	C1=X(1)*Y(2)+Y(1)*X(3)+X(2)*Y(3)
     2-Y(2)*X(3)-Y(1)*X(2)-X(1)*Y(3)
	A2=Y(2)*Z(3)+Z(2)*Y(4)+Y(3)*Z(4)
     2-Z(3)*Y(4)-Z(2)*Y(3)-Y(2)*Z(4)
	B2=Z(2)*X(3)+X(2)*Z(4)+Z(3)*X(4)
     2-X(3)*Z(4)-X(2)*Z(3)-Z(2)*X(4)
	C2=X(2)*Y(3)+Y(2)*X(4)+X(3)*Y(4)
     2-Y(3)*X(4)-Y(2)*X(3)-X(2)*Y(4)
	D1=A1*A1+B1*B1+C1*C1
	D2=A2*A2+B2*B2+C2*C2
	D1=SQRT(D1*D2)
	D2=A1*A2+B1*B2+C1*C2
	ANGL=D2/D1
	RETURN
	END



